<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Health Hero Rush: Enrollment Run</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #fff7f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      color: #1a1a1a;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #game-container {
      position: relative;
      width: 960px;
      height: 540px;
      background: #87ceeb;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      background: linear-gradient(#87ceeb, #fff7f0);
    }
    #hud {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      font-size: 13px;
      border-radius: 8px;
      align-items: center;
      z-index: 5;
    }
    .hud-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 999px;
      gap: 4px;
      white-space: nowrap;
    }
    .hud-label { font-weight: 600; }
    #pause-btn {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ff7a00;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    #pause-btn:hover { background: #c55d00; }

    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: none;
    }
    .overlay.visible {
      display: flex;
      pointer-events: auto;
    }
    .panel {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px 24px;
      width: 480px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .panel h1, .panel h2, .panel h3 {
      margin-bottom: 12px;
      color: #1a1a1a;
    }
    .panel p {
      margin-bottom: 8px;
      font-size: 14px;
      color: #444;
    }
    .panel label {
      display: block;
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
    }
    .panel input, .panel select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: flex-end;
    }
    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .btn-primary {
      background: #ff7a00;
      color: #fff;
    }
    .btn-primary:hover { background: #c55d00; }
    .btn-ghost {
      background: #f3f3f3;
      color: #333;
    }
    .btn-ghost:hover { background: #e0e0e0; }

    #warning-text {
      color: #d32f2f;
      font-weight: 600;
      margin-top: 8px;
      font-size: 13px;
    }

    #splash-options button {
      width: 100%;
      margin-top: 8px;
    }
    .overlay-fullscreen-label {
      font-size: 12px;
      margin-top: 8px;
      color: #666;
    }

    /* Persona selection RPG-style */
    .persona-columns {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-top: 8px;
    }
    .hero-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .hero-card {
      border-radius: 10px;
      padding: 10px;
      background: #fff7f0;
      border: 2px solid transparent;
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 10px;
      align-items: center;
    }
    .hero-card.selected {
      border-color: #ff7a00;
      box-shadow: 0 0 0 2px rgba(255,122,0,0.2);
    }
    .hero-portrait {
      background: #e0e0e0;
      border-radius: 8px;
      width: 72px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #555;
      text-align: center;
      padding: 4px;
    }
    .hero-meta h3 {
      font-size: 14px;
      margin-bottom: 4px;
    }
    .hero-meta p {
      font-size: 12px;
      margin-bottom: 4px;
    }
    .hero-tagline {
      font-size: 11px;
      color: #666;
    }

    .persona-options {
      border-radius: 10px;
      background: #faf5ff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 11px;
      cursor: pointer;
      background: #fff;
    }
    .chip.selected {
      border-color: #ff7a00;
      background: #ffe0c2;
    }
    .persona-hint {
      font-size: 12px;
      margin-top: 6px;
      color: #777;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game" width="960" height="540"></canvas>

    <!-- Custom BGM -->
    <audio id="bgm" src="audio/bgm.mp3" loop></audio>

    <div id="hud">
      <div class="hud-chip"><span class="hud-label">Wallet:</span> <span id="hud-wallet">₹0</span></div>
      <div class="hud-chip"><span class="hud-label">Coins:</span> <span id="hud-coins">0</span></div>
      <div class="hud-chip"><span class="hud-label">Progress:</span> <span id="hud-progress">0/4</span></div>
      <div class="hud-chip" id="hud-outofpocket-chip">
        <span class="hud-label">Your cost:</span> <span id="hud-outofpocket">₹0</span>
      </div>
      <div class="hud-chip" id="hud-current-selection">
        <span class="hud-label">Current:</span> <span id="hud-current-text">-</span>
      </div>
      <button id="pause-btn">Pause</button>
    </div>

    <!-- Splash / Home -->
    <div class="overlay" id="splash-overlay">
      <div class="panel">
        <h1>Health Hero Rush</h1>
        <p>Run, jump and complete your health insurance enrollment like a proper RPG hero.</p>
        <div id="splash-options">
          <button class="btn btn-primary" id="btn-new-game">New Game (Enter)</button>
          <button class="btn btn-ghost" id="btn-continue">Continue with mobile number</button>
          <button class="btn btn-ghost" id="btn-admin">Admin / HR Console</button>
        </div>
        <p class="overlay-fullscreen-label">Controls: Arrow keys to move / jump, Enter to interact, Esc to pause.</p>
      </div>
    </div>

    <!-- Auth overlay -->
    <div class="overlay" id="auth-overlay">
      <div class="panel">
        <h2>Resume with Mobile Number</h2>
        <p>We will try to find your saved enrollment run.</p>
        <label>Mobile number (+91)</label>
        <input id="auth-mobile" placeholder="9876543210" />
        <div class="btn-row">
          <button class="btn btn-ghost" id="auth-cancel">Cancel</button>
          <button class="btn btn-primary" id="auth-submit">Find my game</button>
        </div>
        <p id="auth-status" style="margin-top:8px;font-size:13px;color:#666;"></p>
      </div>
    </div>

    <!-- Persona selection RPG-style -->
    <div class="overlay" id="persona-overlay">
      <div class="panel">
        <h2>Choose your Hero</h2>
        <p>Use arrow keys to move, Enter to confirm. This decides your story flavour; you can still pick any plan later.</p>
        <div class="persona-columns">
          <div class="hero-list" id="hero-list">
            <div class="hero-card" data-hero="metro_maverick">
              <div class="hero-portrait">Hero Portrait Placeholder</div>
              <div class="hero-meta">
                <h3>Metro Maverick</h3>
                <p>Office by day, gamer by night, always chasing the last local train.</p>
                <p class="hero-tagline">Best suited for early-career folks setting up cover for themselves or partner.</p>
              </div>
            </div>
            <div class="hero-card" data-hero="doc_defender">
              <div class="hero-portrait">Hero Portrait Placeholder</div>
              <div class="hero-meta">
                <h3>Doc Defender</h3>
                <p>Knows how hospitals work and wants a clinically solid policy.</p>
                <p class="hero-tagline">Good for those who prioritise comprehensive cover.</p>
              </div>
            </div>
            <div class="hero-card" data-hero="namma_shield">
              <div class="hero-portrait">Hero Portrait Placeholder</div>
              <div class="hero-meta">
                <h3>Namma Shield</h3>
                <p>Balances parents, partner and kids like a pro juggler.</p>
                <p class="hero-tagline">Ideal for full family coverage in one go.</p>
              </div>
            </div>
            <div class="hero-card" data-hero="tech_tiger">
              <div class="hero-portrait">Hero Portrait Placeholder</div>
              <div class="hero-meta">
                <h3>Tech Tiger</h3>
                <p>Optimises everything: tax, cover, add-ons, even coffee intake.</p>
                <p class="hero-tagline">Loves fine-tuning plans and add-ons for value.</p>
              </div>
            </div>
          </div>
          <div class="persona-options">
            <div>
              <strong>Age band</strong>
              <div class="chip-row" id="age-chips">
                <div class="chip" data-age="18-25">18–25</div>
                <div class="chip" data-age="26-35">26–35</div>
                <div class="chip" data-age="36-45">36–45</div>
                <div class="chip" data-age="45+">45+</div>
              </div>
            </div>
            <div>
              <strong>Family status</strong>
              <div class="chip-row" id="family-chips">
                <div class="chip" data-family="single">Single</div>
                <div class="chip" data-family="married">Married</div>
                <div class="chip" data-family="married_parents">Married + Parents</div>
                <div class="chip" data-family="married_parents_kids">Married + Parents + Kids</div>
              </div>
            </div>
          </div>
        </div>
        <p class="persona-hint">Up/Down to change hero, Left/Right to move within selections. Enter to start.</p>
        <div class="btn-row">
          <button class="btn btn-primary" id="persona-start">Start Wallet Run</button>
        </div>
      </div>
    </div>

    <!-- Plan modal -->
    <div class="overlay" id="plan-modal-overlay">
      <div class="panel" id="plan-panel">
        <h2 id="plan-modal-title"></h2>
        <p id="plan-modal-desc"></p>
        <p><strong>Sum insured:</strong> <span id="plan-modal-sum"></span></p>
        <p><strong>Family covered:</strong> <span id="plan-modal-family"></span></p>
        <p><strong>Price:</strong> <span id="plan-modal-price"></span></p>
        <p><strong>Wallet used:</strong> <span id="plan-modal-wallet"></span></p>
        <p><strong>Remaining wallet:</strong> <span id="plan-modal-remaining"></span></p>
        <p><strong>Out-of-pocket:</strong> <span id="plan-modal-outofpocket"></span></p>
        <p id="plan-modal-selected-flag" style="font-size:13px;color:#1ba672;font-weight:600;display:none;">This plan is currently selected.</p>
        <p id="plan-modal-sponsored" style="font-size:13px;color:#1ba672;font-weight:600;display:none;">Company-sponsored recommended plan.</p>
        <p style="font-size:12px;color:#777;margin-top:8px;">Use Left/Right to move between plans. Enter to select, Esc to close.</p>
        <div class="btn-row">
          <button class="btn btn-ghost" id="plan-modal-prev">Previous plan</button>
          <button class="btn btn-ghost" id="plan-modal-next">Next plan</button>
          <button class="btn btn-primary" id="plan-modal-select">Select this plan</button>
        </div>
      </div>
    </div>

    <!-- Dependent modal -->
    <div class="overlay" id="dependent-modal-overlay">
      <div class="panel">
        <h2 id="dep-modal-title">Add dependent</h2>
        <label>Name</label>
        <input id="dep-name" />
        <label>Date of birth</label>
        <input id="dep-dob" placeholder="DD/MM/YYYY" />
        <label>Gender</label>
        <select id="dep-gender">
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
          <option value="na">Prefer not say</option>
        </select>
        <label>Phone</label>
        <input id="dep-phone" placeholder="9876543210" />
        <label>Relationship</label>
        <input id="dep-relationship" readonly />
        <div class="btn-row">
          <button class="btn btn-ghost" id="dep-cancel">Cancel</button>
          <button class="btn btn-primary" id="dep-save">Save dependent</button>
        </div>
      </div>
    </div>

    <!-- Add-on modal -->
    <div class="overlay" id="addon-modal-overlay">
      <div class="panel">
        <h2 id="addon-title"></h2>
        <p id="addon-desc"></p>
        <p><strong>Price:</strong> <span id="addon-price"></span></p>
        <p id="addon-compat" style="font-size:13px;"></p>
        <label>
          <input type="checkbox" id="addon-toggle" /> Add this to my coverage
        </label>
        <p id="addon-error" style="color:#d32f2f;font-size:13px;display:none;"></p>
        <div class="btn-row">
          <button class="btn btn-ghost" id="addon-cancel">Not now</button>
          <button class="btn btn-primary" id="addon-save">Save selection</button>
        </div>
      </div>
    </div>

    <!-- Summary / Checkout overlay -->
    <div class="overlay" id="summary-overlay">
      <div class="panel">
        <h2>Review your coverage</h2>
        <div id="summary-content" style="font-size:14px;"></div>
        <label style="margin-top:12px;">
          <input type="checkbox" id="summary-confirm" /> I confirm these details are correct.
        </label>
        <div id="warning-text" style="display:none;"></div>
        <div class="btn-row">
          <button class="btn btn-primary" id="summary-continue-flag">Confirm and go to flag</button>
        </div>
      </div>
    </div>

    <!-- Pause overlay -->
    <div class="overlay" id="pause-overlay">
      <div class="panel" id="pause-panel">
        <h2>Paused</h2>
        <label>Music volume</label>
        <input type="range" id="music-volume" min="0" max="1" step="0.05" value="0.7" />
        <label>SFX volume</label>
        <input type="range" id="sfx-volume" min="0" max="1" step="0.05" value="0.7" />
        <label>
          <input type="checkbox" id="mute-toggle" /> Mute all audio
        </label>
        <div class="btn-row">
          <button class="btn btn-ghost" id="pause-exit">Exit to main menu</button>
          <button class="btn btn-primary" id="pause-resume">Resume</button>
        </div>
      </div>
    </div>

    <!-- Admin console (placeholder) -->
    <div class="overlay" id="admin-overlay">
      <div class="panel" style="width:600px;">
        <h2>Admin / HR Console (demo)</h2>
        <p>Config is currently editable via JavaScript constants (PLANS, ADDONS, WALLET_SETTINGS).</p>
        <p>Next iteration: full editable UI with saveable JSON.</p>
        <div class="btn-row">
          <button class="btn btn-primary" id="admin-close">Back</button>
        </div>
      </div>
    </div>

    <!-- Celebration overlay -->
    <div class="overlay" id="celebration-overlay">
      <div class="panel">
        <h2>Enrollment complete</h2>
        <p id="celebration-text"></p>
        <div class="btn-row">
          <button class="btn btn-primary" id="celebration-home">Back to Home</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ------------------------------------
    // CONFIG / DATA
    // ------------------------------------
    const PLANS = [
      {
        id: "PLAN_COMP",
        name: "Company Shield",
        description: "Company-sponsored, solid cover for you and family.",
        monthlyPrice: 2500,
        sumInsured: "₹5,00,000",
        familyCoverage: "Self + Spouse + 2 Parents",
        companySponsored: true,
        dependentSlotCount: 3
      },
      {
        id: "PLAN_VALUE",
        name: "Value Saver",
        description: "Lower premium, ideal if you visit doctors rarely.",
        monthlyPrice: 1800,
        sumInsured: "₹3,00,000",
        familyCoverage: "Self + Spouse",
        companySponsored: false,
        dependentSlotCount: 2
      },
      {
        id: "PLAN_PREMIUM",
        name: "Premium Plus",
        description: "Maximum coverage, add-ons friendly, peace of mind.",
        monthlyPrice: 3500,
        sumInsured: "₹10,00,000",
        familyCoverage: "Self + Spouse + 2 Parents + 2 Kids",
        companySponsored: false,
        dependentSlotCount: 4
      },
      {
        id: "PLAN_SINGLE",
        name: "Solo Basic",
        description: "For single heroes who like being independent.",
        monthlyPrice: 1500,
        sumInsured: "₹2,00,000",
        familyCoverage: "Self only",
        companySponsored: false,
        dependentSlotCount: 0
      }
    ];

    const ADDONS = [
      { id: "ADDON_FITNESS",   name: "Fitness Subscription",       type: "fitness",   price: 400, desc: "Gym / yoga credits to keep you in superhero shape.",                     requiredPlanIds: [] },
      { id: "ADDON_DENTAL",    name: "Dental Cover",               type: "dental",    price: 300, desc: "Covers basic dental procedures and clean-ups.",                       requiredPlanIds: ["PLAN_COMP","PLAN_PREMIUM"] },
      { id: "ADDON_OPD",       name: "OPD Cover",                  type: "opd",       price: 500, desc: "Covers OPD doctor visits up to a limit.",                             requiredPlanIds: ["PLAN_COMP", "PLAN_VALUE", "PLAN_PREMIUM"] },
      { id: "ADDON_CHECKUPS",  name: "Annual Health Check-ups",    type: "checkup",   price: 350, desc: "Yearly full-body checkup to keep an eye on everything.",             requiredPlanIds: [] },
      { id: "ADDON_MATERNITY", name: "Maternity Plan",             type: "maternity", price: 650, desc: "Covers maternity-related hospitalisation.",                             requiredPlanIds: ["PLAN_COMP","PLAN_PREMIUM"] },
      { id: "ADDON_SPECIAL",   name: "Speciality Add-on",          type: "specialty", price: 420, desc: "Extra cover for speciality treatments.",                             requiredPlanIds: ["PLAN_PREMIUM"] }
    ];

    const WALLET_SETTINGS = {
      baseWallet: 10000,
      coinValue: 50,
      angelMultiplier: 1.5,
      angelDurationSeconds: 60,
      maxAngelSpawns: 3
    };

    const STORAGE_KEY = "health_hero_enrollment";

    // ------------------------------------
    // AUDIO: HTML5 BGM + simple SFX beeps
    // ------------------------------------
    const bgm = document.getElementById("bgm");
    bgm.volume = 0.7;

    let sfxVolume = 0.7;
    let muted = false;

    function playBGM() {
      if (muted) return;
      bgm.play().catch(() => {});
    }
    function stopBGM() {
      bgm.pause();
      bgm.currentTime = 0;
    }
    function playSFXBeep(pitch = 880, duration = 0.1) {
      if (muted || sfxVolume <= 0) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = pitch;
      osc.connect(gain);
      gain.connect(ctx.destination);
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(sfxVolume, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
      osc.start(now);
      osc.stop(now + duration);
    }

    // ------------------------------------
    // GAME STATE
    // ------------------------------------
    const Screen = {
      SPLASH: "SPLASH",
      PERSONA: "PERSONA",
      WALLET_RUN: "WALLET_RUN",
      LEVEL1_PLANS: "LEVEL1_PLANS",
      LEVEL2_DEPS: "LEVEL2_DEPS",
      LEVEL3_ADDONS: "LEVEL3_ADDONS",
      LEVEL4_SUMMARY: "LEVEL4_SUMMARY",
      COMPLETE: "COMPLETE",
      PAUSE: "PAUSE",
      ADMIN: "ADMIN"
    };

    let gameState = {
      screen: Screen.SPLASH,
      persona: null,
      wallet: {
        baseWallet: WALLET_SETTINGS.baseWallet,
        currentWalletAmount: WALLET_SETTINGS.baseWallet,
        coinsCollected: 0,
        angelMultiplierActive: false,
        angelMultiplier: 1,
        angelMultiplierExpiresAt: 0,
        angelSpawnsUsed: 0
      },
      enrollment: {
        selectedPlanId: null,
        dependents: [],
        selectedAddOns: [],
        totalCost: 0,
        walletUsage: 0,
        outOfPocketCost: 0,
        progressStage: 0
      },
      angel: { active: false, x: 0, y: 0 },
      mobileNumber: null
    };

    const canvas = document.getElementById("game");
    const ctx2d = canvas.getContext("2d");

    const hudWallet = document.getElementById("hud-wallet");
    const hudCoins = document.getElementById("hud-coins");
    const hudProgress = document.getElementById("hud-progress");
    const hudOutOfPocket = document.getElementById("hud-outofpocket");
    const hudOutChip = document.getElementById("hud-outofpocket-chip");
    const hudCurrentText = document.getElementById("hud-current-text");

    const splashOverlay = document.getElementById("splash-overlay");
    const personaOverlay = document.getElementById("persona-overlay");
    const planModalOverlay = document.getElementById("plan-modal-overlay");
    const depModalOverlay = document.getElementById("dependent-modal-overlay");
    const addonModalOverlay = document.getElementById("addon-modal-overlay");
    const summaryOverlay = document.getElementById("summary-overlay");
    const pauseOverlay = document.getElementById("pause-overlay");
    const adminOverlay = document.getElementById("admin-overlay");
    const celebrationOverlay = document.getElementById("celebration-overlay");
    const authOverlay = document.getElementById("auth-overlay");

    const GRAVITY = 0.7;
    const MOVE_SPEED = 4.5;
    const JUMP_SPEED = -12;
    const ACCEL = 0.5;
    const FRICTION = 0.6;

    const player = { x: 100, y: 0, w: 32, h: 40, vx: 0, vy: 0, onGround: false };
    const keys = { left: false, right: false, up: false };
    let lastTime = performance.now();
    let paused = false;
    let waitingForFlagRun = false;
    let levelTimer = 0;
    let coyoteTime = 0;
    const COYOTE_MS = 80;
    let prevY = 0;

    const levelData = {
      WALLET_RUN: {
        ground: [{ x:0,y:480,w:2000,h:60 }],
        coins: [
          {x:200,y:380},{x:240,y:350},{x:280,y:320},
          {x:450,y:380},{x:490,y:350},{x:530,y:320}
        ],
        bricks: [
          {x:350,y:330,w:40,h:20},
          {x:390,y:330,w:40,h:20}
        ],
        enemies: [],
        exitX: 900
      },
      LEVEL1_PLANS: {
        ground: [{x:0,y:480,w:2000,h:60}],
        platformsPre: [
          {x:150,y:400,w:100,h:20},
          {x:300,y:360,w:100,h:20},
          {x:450,y:320,w:100,h:20},
          {x:600,y:360,w:100,h:20}
        ],
        bricks: [
          {x:250,y:300,w:40,h:20},
          {x:290,y:300,w:40,h:20}
        ],
        planPlatforms: [
          {x:120,y:380,w:180,h:70,planId:"PLAN_COMP"},
          {x:340,y:380,w:180,h:70,planId:"PLAN_VALUE"},
          {x:560,y:380,w:180,h:70,planId:"PLAN_PREMIUM"},
          {x:780,y:380,w:180,h:70,planId:"PLAN_SINGLE"}
        ],
        enemies: [
          {x:350,y:448,w:32,h:32,dx:1}
        ],
        coins: [],
        exitX: 950
      },
      LEVEL2_DEPS: {
        ground: [{x:0,y:480,w:2000,h:60}],
        slots: [],
        enemies: [],
        bricks: [],
        exitX: 900
      },
      LEVEL3_ADDONS: {
        ground: [{x:0,y:480,w:2000,h:60}],
        platformsPre: [
          {x:150,y:400,w:100,h:20},
          {x:300,y:360,w:100,h:20},
          {x:450,y:380,w:100,h:20}
        ],
        bricks: [
          {x:220,y:320,w:40,h:20}
        ],
        addonPickups: [],
        enemies: [{x:500,y:448,w:32,h:32,dx:-1}],
        coins: [{x:220,y:380},{x:260,y:350}],
        exitX: 940
      },
      LEVEL4_SUMMARY: {
        ground: [{x:0,y:480,w:2000,h:60}],
        bricks: [],
        exitX: 900
      }
    };

    function setupDependentsSlots() {
      const selectedPlan = PLANS.find(p => p.id === gameState.enrollment.selectedPlanId);
      const slots = [];
      const baseY = 420;
      const startX = 200;
      if (!selectedPlan) return;
      const rels = [];
      const fs = gameState.persona.familyStatus;
      if (fs === "married") rels.push("Spouse");
      else if (fs === "married_parents") rels.push("Spouse","Parent 1","Parent 2");
      else if (fs === "married_parents_kids") rels.push("Spouse","Parent 1","Parent 2","Child 1");
      const max = Math.min(selectedPlan.dependentSlotCount, rels.length);
      for (let i=0;i<max;i++) {
        slots.push({ x:startX + i*160, y:baseY, w:80, h:30, relationship:rels[i], filled:false, depId:null });
      }
      levelData.LEVEL2_DEPS.slots = slots;
    }

    function setupAddonsPickups() {
      const baseY = 420;
      const startX = 200;
      const arr = [];
      ADDONS.forEach((addon,i) => {
        arr.push({ x:startX + i*120, y:baseY, w:40,h:40, addonId:addon.id });
      });
      levelData.LEVEL3_ADDONS.addonPickups = arr;
    }

    // ------------------------------------
    // INPUT HANDLING (KEYBOARD)
    // ------------------------------------
    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a") keys.left = true;
      if (e.key === "ArrowRight" || e.key === "d") keys.right = true;
      if (e.key === "ArrowUp" || e.key === "w" || e.key === " ") keys.up = true;

      if (gameState.screen === Screen.PERSONA && personaOverlay.classList.contains("visible")) {
        personaHandleKey(e.key);
      }

      if (e.key === "Escape") {
        if (closeAnyModal()) return;
        togglePause();
      }
      if (e.key === "Enter") {
        handleEnterKey();
      }
    });
    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a") keys.left = false;
      if (e.key === "ArrowRight" || e.key === "d") keys.right = false;
      if (e.key === "ArrowUp" || e.key === "w" || e.key === " ") keys.up = false;
    });

    function togglePause() {
      if (gameState.screen === Screen.SPLASH || gameState.screen === Screen.ADMIN || isAnyModalOpen()) return;
      paused = !paused;
      pauseOverlay.classList.toggle("visible", paused);
      if (paused) {
        gameState.screenBeforePause = gameState.screen;
        gameState.screen = Screen.PAUSE;
        bgm.pause();
      } else {
        gameState.screen = gameState.screenBeforePause || Screen.WALLET_RUN;
        playBGM();
      }
    }

    // ------------------------------------
    // SAVE / LOAD
    // ------------------------------------
    function saveGame() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
      } catch(e) {}
    }

    function loadGameByMobile(mobile) {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        if (data.mobileNumber === mobile) return data;
      } catch(e) {}
      return null;
    }

    // ------------------------------------
    // UI WIRING
    // ------------------------------------
    document.getElementById("btn-new-game").onclick = () => {
      splashOverlay.classList.remove("visible");
      showPersonaOverlay();
    };
    document.getElementById("btn-continue").onclick = () => {
      splashOverlay.classList.remove("visible");
      authOverlay.classList.add("visible");
    };
    document.getElementById("btn-admin").onclick = () => {
      splashOverlay.classList.remove("visible");
      adminOverlay.classList.add("visible");
      gameState.screen = Screen.ADMIN;
    };
    document.getElementById("admin-close").onclick = () => {
      adminOverlay.classList.remove("visible");
      splashOverlay.classList.add("visible");
      gameState.screen = Screen.SPLASH;
    };

    // Auth
    document.getElementById("auth-cancel").onclick = () => {
      authOverlay.classList.remove("visible");
      splashOverlay.classList.add("visible");
    };
    document.getElementById("auth-submit").onclick = () => {
      const mobile = document.getElementById("auth-mobile").value.trim();
      const status = document.getElementById("auth-status");
      const data = loadGameByMobile(mobile);
      if (data) {
        gameState = data;
        status.textContent = "Found your run. Resuming.";
        setTimeout(() => {
          authOverlay.classList.remove("visible");
          startFromSavedState();
        }, 600);
      } else {
        status.textContent = "No saved run found for this number.";
      }
    };

    // Persona selection
    const heroList = document.getElementById("hero-list");
    const heroCards = [...heroList.querySelectorAll(".hero-card")];
    const ageChips = [...document.getElementById("age-chips").querySelectorAll(".chip")];
    const familyChips = [...document.getElementById("family-chips").querySelectorAll(".chip")];
    const personaStartBtn = document.getElementById("persona-start");

    let personaSelection = {
      heroIndex: 0,
      ageIndex: 1,
      familyIndex: 1,
      focus: "hero" // hero | age | family
    };

    function showPersonaOverlay() {
      personaOverlay.classList.add("visible")
